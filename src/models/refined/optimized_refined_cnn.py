import sys
from pathlib import Path

import numpy as np
import tensorflow as tf
from keras.layers import Conv2D, Flatten, Dense, InputLayer
from keras_tuner.src.backend import keras
from tensorflow import keras

from config.config import Config
from models.evaluation.ModelEvaluator import ModelEvaluator
from models.refined.Refined import Refined
from models.refined.RefinedModel import RefinedModel

np.set_printoptions(threshold=sys.maxsize)
import pickle

# refined_order = np.array([133, 213, 961, 894, 1139, 425, 998, 696, 253, 367, 747, 939, 1091, 184,
#                           298, 234, 427, 652, 442, 994, 1050, 194, 650, 385, 1069, 1064, 687, 914,
#                           800, 2, 431, 56, 371, 700, 776, 1041, 349, 577, 1036, 957, 633, 1013,
#                           893, 1059, 907, 450, 1096, 1022, 718, 199, 804, 80, 270, 688, 954, 0,
#                           494, 991, 1067, 154, 50, 173, 75, 370, 482, 1075, 363, 235, 691, 658,
#                           1071, 934, 291, 1053, 261, 1045, 1020, 336, 374, 888, 766, 860, 1012, 536,
#                           233, 1068, 689, 950, 839, 496, 943, 593, 89, 28, 511, 585, 847, 1011,
#                           86, 639, 256, 439, 463, 618, 1101, 825, 166, 789, 827, 109, 902, 1060,
#                           736, 1130, 161, 541, 308, 684, 763, 762, 387, 1037, 26, 980, 182, 189,
#                           61, 353, 327, 631, 31, 970, 10, 276, 853, 164, 521, 294, 820, 204,
#                           979, 982, 82, 850, 123, 576, 1035, 190, 801, 1029, 542, 758, 581, 49,
#                           714, 144, 486, 357, 426, 358, 786, 856, 297, 162, 563, 12, 240, 715,
#                           257, 805, 561, 598, 412, 1131, 1054, 1078, 237, 997, 117, 573, 565, 770,
#                           702, 669, 403, 324, 95, 1094, 168, 319, 730, 1001, 1077, 568, 1132, 1084,
#                           200, 331, 753, 392, 857, 522, 280, 870, 120, 1040, 348, 959, 266, 193,
#                           488, 402, 1138, 1110, 659, 163, 752, 334, 284, 11, 282, 396, 495, 1039,
#                           795, 416, 1023, 1103, 1062, 515, 513, 819, 242, 826, 148, 44, 272, 693,
#                           114, 988, 868, 772, 475, 681, 555, 263, 92, 167, 220, 53, 54, 362,
#                           692, 938, 699, 360, 927, 183, 1008, 873, 968, 781, 933, 636, 1015, 452,
#                           1055, 632, 1031, 3, 716, 1086, 987, 249, 859, 976, 254, 201, 227, 132,
#                           210, 286, 330, 558, 634, 457, 609, 871, 530, 1024, 174, 782, 1124, 675,
#                           413, 146, 908, 328, 765, 380, 224, 595, 136, 791, 407, 569, 145, 229,
#                           122, 58, 103, 676, 198, 292, 471, 343, 36, 590, 264, 255, 361, 466,
#                           1095, 1048, 779, 831, 546, 1098, 845, 955, 708, 110, 1000, 1119, 778, 664,
#                           932, 920, 621, 35, 524, 19, 171, 134, 125, 479, 509, 885, 643, 1137,
#                           1018, 314, 981, 1120, 90, 863, 470, 528, 842, 1106, 156, 465, 931, 667,
#                           212, 60, 142, 925, 768, 472, 274, 828, 37, 448, 8, 320, 517, 809,
#                           571, 723, 474, 105, 316, 884, 899, 971, 641, 300, 176, 1030, 271, 594,
#                           983, 592, 589, 98, 1100, 1014, 381, 547, 400, 84, 130, 27, 359, 248,
#                           277, 393, 74, 628, 851, 493, 1005, 846, 668, 557, 855, 1121, 389, 840,
#                           613, 4, 941, 489, 919, 278, 835, 966, 1034, 529, 441, 216, 149, 16,
#                           169, 246, 87, 355, 662, 745, 1042, 1118, 483, 506, 767, 810, 1127, 526,
#                           940, 423, 764, 1108, 72, 451, 14, 250, 273, 335, 909, 661, 672, 654,
#                           191, 23, 473, 296, 600, 187, 305, 377, 958, 928, 121, 829, 1081, 635,
#                           443, 32, 756, 499, 803, 784, 794, 603, 671, 615, 430, 202, 135, 605,
#                           923, 844, 267, 467, 111, 321, 18, 170, 379, 434, 368, 578, 7, 124,
#                           352, 364, 743, 717, 832, 346, 879, 746, 62, 1021, 481, 1112, 653, 504,
#                           445, 761, 1080, 821, 624, 502, 64, 281, 265, 93, 141, 322, 315, 391,
#                           453, 1065, 287, 468, 843, 945, 906, 81, 342, 118, 100, 222, 937, 63,
#                           922, 949, 428, 48, 1099, 1128, 710, 476, 619, 241, 127, 113, 131, 96,
#                           206, 225, 545, 799, 815, 656, 960, 375, 564, 157, 418, 43, 503, 70,
#                           975, 101, 1057, 354, 311, 293, 531, 757, 623, 887, 657, 312, 99, 243,
#                           1, 65, 303, 115, 505, 1125, 834, 238, 867, 1038, 792, 898, 456, 384,
#                           690, 754, 356, 665, 729, 808, 677, 739, 587, 647, 719, 533, 735, 438,
#                           350, 317, 236, 245, 258, 866, 251, 897, 1087, 373, 487, 1051, 108, 252,
#                           532, 574, 366, 260, 394, 861, 620, 1043, 854, 777, 1122, 549, 492, 999,
#                           996, 849, 773, 540, 279, 39, 562, 17, 143, 491, 963, 1115, 644, 711,
#                           329, 386, 570, 612, 480, 602, 33, 749, 972, 551, 929, 401, 645, 625,
#                           1056, 1061, 378, 833, 112, 695, 433, 395, 165, 410, 68, 399, 175, 738,
#                           1004, 45, 1074, 223, 646, 461, 918, 774, 337, 787, 703, 706, 516, 580,
#                           22, 701, 720, 179, 951, 965, 973, 814, 596, 583, 429, 91, 283, 151,
#                           435, 419, 748, 947, 408, 823, 915, 537, 974, 214, 984, 527, 817, 405,
#                           597, 295, 797, 626, 948, 550, 1027, 913, 107, 1090, 862, 520, 365, 239,
#                           46, 15, 30, 552, 742, 890, 986, 1019, 877, 836, 422, 670, 6, 622,
#                           751, 1123, 447, 630, 892, 740, 525, 588, 97, 989, 1003, 813, 567, 339,
#                           510, 507, 140, 160, 66, 372, 77, 444, 1113, 905, 1104, 79, 498, 1070,
#                           196, 978, 755, 713, 895, 1025, 694, 218, 325, 29, 217, 512, 985, 340,
#                           302, 852, 514, 548, 616, 137, 13, 790, 94, 226, 900, 601, 952, 912,
#                           5, 1032, 964, 414, 788, 712, 627, 1063, 554, 553, 104, 247, 796, 682,
#                           455, 1117, 904, 398, 775, 882, 415, 464, 153, 51, 208, 55, 397, 685,
#                           876, 41, 119, 807, 9, 698, 640, 903, 519, 734, 485, 326, 180, 126,
#                           285, 211, 59, 21, 942, 837, 417, 889, 666, 733, 543, 178, 129, 638,
#                           106, 811, 838, 155, 38, 195, 518, 158, 1083, 969, 432, 1085, 1010, 333,
#                           629, 369, 181, 159, 663, 606, 221, 454, 818, 69, 1049, 935, 771, 697,
#                           406, 244, 20, 207, 724, 497, 152, 802, 936, 310, 566, 901, 750, 741,
#                           215, 896, 744, 409, 437, 219, 759, 390, 67, 683, 872, 411, 607, 436,
#                           737, 150, 707, 102, 203, 209, 686, 307, 228, 726, 617, 138, 1092, 1058,
#                           864, 318, 674, 637, 52, 484, 332, 478, 591, 288, 477, 891, 816, 449,
#                           910, 1046, 780, 341, 1072, 586, 469, 172, 648, 611, 722, 878, 731, 462,
#                           1002, 1093, 660, 1017, 584, 869, 1114, 1109, 1009, 1033, 858, 582, 732, 930,
#                           967, 911, 721, 83, 875, 1079, 1052, 806, 301, 205, 458, 649, 1026, 992,
#                           921, 614, 424, 926, 186, 678, 1134, 679, 865, 673, 560, 599, 446, 1133,
#                           1082, 705, 1006, 559, 539, 88, 197, 259, 188, 783, 824, 73, 382, 1105,
#                           1102, 309, 460, 728, 290, 1116, 1129, 812, 1016, 944, 1007, 977, 1135, 185,
#                           71, 1089, 785, 128, 1076, 962, 886, 177, 25, 881, 544, 501, 704, 388,
#                           306, 420, 231, 76, 1111, 956, 313, 351, 556, 275, 24, 85, 47, 1136,
#                           604, 642, 490, 376, 830, 508, 793, 1097, 147, 1047, 709, 924, 523, 995,
#                           1044, 289, 268, 344, 383, 608, 1107, 917, 651, 727, 575, 1073, 883, 232,
#                           1088, 769, 1126, 655, 42, 880, 404, 579, 538, 500, 680, 262, 338, 34,
#                           299, 848, 440, 57, 40, 78, 116, 192, 230, 534, 572, 610, 990, 1028,
#                           1066, 725, 953, 535, 459, 421, 269, 345, 874, 760, 798, 304, 993, 916,
#                           841, 347, 822, 946, 139, 323])

refined_order = [887, 1027, 899, 861, 881, 810, 820, 794, 641, 90, 868, 318, 9, 47, 1002, 997, 1108, 328, 708, 42, 574,
                 613, 1069, 760, 950, 1102, 952, 610, 458, 2, 251, 596, 685, 530, 329, 582, 886, 977, 180, 946, 931,
                 1096, 356, 903, 82, 1054, 351, 1032, 442, 898, 118, 536, 385, 114, 532, 988, 1029, 1067, 496, 306, 74,
                 225, 353, 1023, 949, 253, 247, 174, 939, 452, 294, 603, 108, 450, 716, 902, 85, 655, 807, 100, 480, 43,
                 460, 650, 612, 722, 383, 725, 1066, 686, 1133, 1041, 999, 583, 1001, 301, 970, 94, 948, 797, 777, 240,
                 288, 477, 402, 333, 291, 370, 52, 671, 598, 751, 642, 983, 272, 880, 117, 953, 1104, 762, 854, 227,
                 745, 654, 391, 555, 324, 951, 321, 1024, 1018, 133, 88, 466, 98, 653, 629, 805, 857, 919, 63, 675, 712,
                 1097, 978, 1129, 308, 874, 687, 914, 86, 740, 761, 495, 695, 87, 1034, 243, 567, 246, 65, 663, 1057,
                 853, 325, 967, 591, 559, 972, 1074, 933, 633, 673, 937, 489, 158, 784, 646, 497, 991, 680, 316, 525,
                 1080, 248, 23, 84, 1052, 1087, 719, 75, 113, 69, 943, 905, 293, 930, 349, 354, 218, 1119, 1112, 696,
                 747, 470, 336, 594, 727, 231, 877, 485, 615, 48, 189, 909, 1049, 730, 89, 844, 958, 53, 585, 780, 1065,
                 284, 359, 625, 135, 701, 390, 816, 257, 447, 519, 817, 488, 918, 860, 41, 915, 831, 668, 162, 828, 17,
                 875, 963, 213, 198, 581, 403, 115, 738, 357, 681, 207, 410, 341, 790, 27, 601, 439, 506, 561, 863,
                 1055, 541, 290, 380, 345, 484, 1124, 121, 721, 715, 1099, 833, 624, 925, 127, 464, 923, 434, 77, 319,
                 889, 150, 31, 568, 473, 179, 835, 656, 367, 711, 793, 576, 1111, 76, 836, 830, 338, 219, 159, 59, 220,
                 927, 395, 167, 920, 178, 735, 900, 1110, 229, 666, 775, 1079, 454, 752, 455, 50, 968, 781, 1114, 984,
                 424, 1070, 1106, 608, 944, 908, 481, 580, 331, 531, 373, 471, 476, 365, 216, 125, 350, 505, 396, 73,
                 281, 799, 106, 714, 904, 739, 542, 934, 1071, 1060, 462, 24, 764, 304, 412, 451, 1089, 544, 987, 1056,
                 436, 894, 457, 441, 768, 429, 8, 254, 16, 134, 267, 400, 985, 600, 866, 753, 504, 1139, 743, 787, 964,
                 994, 878, 342, 1078, 602, 256, 104, 425, 1019, 474, 297, 433, 935, 472, 444, 64, 51, 578, 697, 510,
                 859, 529, 1103, 145, 910, 197, 428, 705, 599, 148, 804, 384, 840, 386, 196, 971, 1086, 361, 126, 683,
                 1094, 818, 552, 821, 282, 1113, 558, 13, 317, 1075, 320, 129, 989, 169, 379, 720, 211, 143, 734, 1033,
                 237, 959, 917, 119, 579, 280, 962, 139, 1082, 287, 626, 1122, 1117, 966, 700, 593, 1072, 393, 102, 292,
                 616, 1, 343, 814, 258, 682, 981, 60, 729, 975, 199, 693, 422, 271, 614, 508, 446, 409, 101, 911, 873,
                 492, 56, 1118, 453, 1011, 153, 172, 824, 163, 482, 58, 210, 111, 36, 151, 21, 209, 691, 744, 185, 310,
                 765, 499, 652, 788, 703, 443, 658, 884, 212, 235, 524, 448, 871, 647, 571, 263, 1115, 885, 140, 502,
                 1037, 20, 415, 264, 107, 369, 1120, 557, 128, 1092, 309, 879, 845, 754, 72, 595, 177, 706, 285, 67,
                 550, 796, 372, 965, 547, 377, 707, 938, 330, 165, 659, 289, 928, 737, 813, 588, 829, 364, 109, 850,
                 366, 1031, 1035, 1093, 566, 204, 523, 998, 392, 387, 249, 563, 834, 322, 131, 533, 35, 976, 54, 274,
                 11, 540, 305, 852, 890, 37, 182, 597, 490, 979, 214, 0, 632, 70, 604, 779, 405, 843, 767, 407, 136,
                 255, 103, 398, 283, 18, 509, 96, 92, 469, 426, 203, 996, 358, 191, 609, 132, 511, 326, 941, 138, 190,
                 974, 1131, 893, 870, 1051, 995, 513, 1005, 401, 238, 677, 607, 221, 93, 661, 1090, 631, 811, 545, 279,
                 49, 786, 586, 339, 795, 360, 273, 901, 1020, 228, 1050, 146, 1059, 1136, 855, 627, 620, 577, 516, 12,
                 276, 1100, 638, 296, 723, 662, 149, 168, 733, 61, 315, 241, 862, 973, 913, 170, 1127, 181, 907, 266,
                 1126, 888, 6, 147, 528, 224, 895, 437, 501, 66, 22, 57, 549, 486, 55, 1125, 438, 286, 806, 773, 657,
                 520, 122, 847, 39, 259, 10, 105, 1135, 456, 194, 500, 184, 223, 261, 750, 772, 1081, 539, 515, 363,
                 173, 512, 265, 856, 144, 699, 605, 381, 548, 961, 634, 543, 239, 479, 1061, 483, 278, 300, 494, 270,
                 389, 1058, 660, 565, 584, 1085, 960, 399, 867, 352, 645, 1132, 986, 562, 226, 188, 68, 1003, 623, 187,
                 710, 619, 368, 26, 837, 587, 1109, 957, 570, 346, 427, 640, 736, 945, 832, 785, 522, 858, 202, 791, 83,
                 141, 19, 493, 183, 378, 302, 112, 628, 776, 1077, 672, 621, 312, 201, 590, 1025, 709, 79, 726, 731,
                 120, 260, 864, 717, 741, 635, 332, 618, 164, 250, 45, 217, 411, 335, 1084, 416, 1137, 30, 1042, 783,
                 669, 849, 406, 277, 46, 639, 245, 1064, 688, 921, 1121, 374, 812, 1017, 749, 1123, 408, 1095, 371, 892,
                 553, 759, 171, 1138, 487, 980, 417, 644, 932, 643, 514, 1014, 771, 507, 431, 160, 137, 307, 954, 1088,
                 176, 1053, 1134, 969, 622, 848, 166, 551, 1010, 694, 478, 891, 778, 815, 702, 7, 1062, 758, 435, 606,
                 757, 491, 1039, 244, 692, 355, 236, 1028, 269, 233, 80, 503, 1015, 774, 375, 825, 215, 637, 1009, 14,
                 770, 732, 440, 142, 311, 314, 200, 97, 569, 872, 334, 1008, 419, 1128, 130, 99, 388, 876, 573, 537,
                 232, 766, 234, 564, 414, 755, 394, 713, 1047, 468, 1044, 1063, 475, 782, 1043, 554, 323, 445, 28, 463,
                 95, 676, 851, 897, 206, 809, 467, 724, 611, 955, 5, 769, 538, 1091, 926, 1022, 413, 826, 827, 924,
                 1036, 1048, 1101, 896, 521, 667, 295, 630, 808, 1006, 929, 664, 303, 704, 882, 327, 175, 572, 649,
                 1026, 802, 936, 465, 348, 1116, 298, 1007, 756, 679, 71, 546, 865, 432, 789, 636, 560, 589, 819, 25,
                 922, 592, 846, 449, 340, 742, 15, 748, 534, 839, 193, 803, 81, 498, 617, 123, 1130, 1083, 1045, 982,
                 526, 698, 940, 869, 299, 337, 33, 674, 186, 665, 1038, 1000, 1013, 29, 942, 947, 91, 517, 344, 990,
                 535, 38, 651, 347, 1073, 883, 4, 728, 690, 313, 161, 1040, 44, 1016, 906, 678, 792, 32, 222, 1021,
                 1098, 262, 1076, 823, 124, 1046, 362, 205, 78, 382, 648, 763, 912, 684, 418, 1107, 993, 1068, 423, 992,
                 916, 157, 156, 1012, 822, 518, 404, 556, 252, 62, 956, 275, 527, 242, 376, 34, 208, 1004, 40, 116, 154,
                 192, 230, 268, 420, 800, 838, 1105, 801, 459, 421, 155, 798, 3, 152, 1030, 841, 689, 575, 461, 195,
                 746, 670, 842, 718, 110, 430, 397]

best_params = {'hp_initial_size': 128, 'hp_growth_factor': 0.5, 'hp_last_dense': 128, 'hp_cnn_layers': 4,
               'hp_learning_rate': 0.0001}


def create_model(hp_initial_size, hp_growth_factor, hp_last_dense, hp_cnn_layers,
                 hp_learning_rate) -> tf.keras.models.Sequential:
    model = tf.keras.models.Sequential([])
    model.add(InputLayer(input_shape=(38, 30, 1)))
    for i in range(hp_cnn_layers):
        try:
            model.add(
                Conv2D(filters=hp_initial_size * (hp_growth_factor ** i), kernel_size=(3, 3), strides=2,
                       activation="relu",
                       name=f"CNN_{i}"))
        except ValueError:
            pass
    model.add(Flatten(name='Flatten'))
    if hp_last_dense > 1:
        model.add(Dense(units=hp_last_dense, activation="relu", name="Dense"))
    model.add(Dense(units=1, name='logits', activation="sigmoid"))
    model.compile(loss=tf.keras.losses.BinaryCrossentropy(),
                  optimizer=keras.optimizers.Adam(learning_rate=hp_learning_rate), metrics=['accuracy'])
    return model


def main():
    config = Config.get_instance()
    with open(config.train_surroundings, "rb") as file:
        data, labels = pickle.load(file)

    refined = Refined(data, 38, 30, "temp", hca_starts=8)
    refined.from_pretrained(refined_order)

    # stop_early = tf.keras.callbacks.EarlyStopping(monitor='val_loss', patience=3)
    # predictor = create_model(**best_params)
    # predictor.fit(refined.transform(data), labels, validation_split=0.2, epochs=100, callbacks=stop_early)
    # rfc_surrounding_model = RefinedModel(predictor, refined, name="_optimized")
    rfc_surrounding_model = RefinedModel.from_folder(Path(
        r"C:\Users\samuel.soukup\Documents\School\refined\data\models\Refinedrefined_optimized\24-04-03--13-31-23"))
    # rfc_surrounding_model.save_model()
    return (ModelEvaluator(rfc_surrounding_model)
            .calculate_basic_metrics()
            .calculate_session_metrics()
            .save_to_file(rfc_surrounding_model.get_result_folder() / "metrics.txt")
            .print())


if __name__ == '__main__':
    main()
    # predictor = create_model(**best_params)
    # predictor.summary()
